name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test and Build
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Show available schemes
      run: xcodebuild -list -project TenThousand.xcodeproj

    - name: Build project
      run: |
        xcodebuild clean build \
          -project TenThousand.xcodeproj \
          -scheme TenThousand \
          -destination 'platform=macOS' \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES

    - name: Run tests with coverage
      run: |
        xcodebuild test \
          -project TenThousand.xcodeproj \
          -scheme TenThousand \
          -destination 'platform=macOS' \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES

    - name: Generate code coverage report
      run: |
        xcrun llvm-cov export \
          -format="lcov" \
          -instr-profile "$(find TestResults -name '*.profdata')" \
          "$(find ~/Library/Developer/Xcode/DerivedData -name 'TenThousand' -type f | head -n 1)" \
          > coverage.lcov || echo "Coverage export failed, continuing..."

    - name: Upload coverage to artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          TestResults
          coverage.lcov
        retention-days: 30

    - name: Test Summary
      if: always()
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "✅ Build completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "✅ Tests executed" >> $GITHUB_STEP_SUMMARY

  lint:
    name: SwiftLint
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: |
        if [ -f .swiftlint.yml ]; then
          swiftlint lint --reporter github-actions-logging
        else
          echo "⚠️  No .swiftlint.yml found, skipping linting"
          exit 0
        fi
